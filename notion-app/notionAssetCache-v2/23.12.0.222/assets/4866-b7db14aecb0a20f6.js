"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[4866],{79474:(e,t,o)=>{o.d(t,{r:()=>n});var r=o(43604);async function n(e){return new Promise((t=>{r.Z.setState({open:!0,onClose:()=>{r.Z.setState({open:!1}),t(!1)},onConfirm:()=>{r.Z.setState({open:!1}),t(!0)},...e})}))}},44866:(e,t,o)=>{o.r(t),o.d(t,{autofillPropertyForBlocks:()=>X,autofillPropertyForCollection:()=>$,fillAllPagesMessages:()=>Z,saveOrRemovePropertyAiInference:()=>ee,submitFeedbackForAiAutofill:()=>J,triggerAiAutofillUpsell:()=>G});o(57658);var r=o(67294),n=o(26263),i=o(99036),a=o(74229),l=o(72126),s=o(5366),c=o(482),d=o(4615),p=o(3791),f=o(97880),u=o(50906),m=o(8406),y=o(54642),g=o(14871),_=o(76427),A=o(79474),I=o(47307),h=o(96802),k=o(9953),v=o(64964),P=o(39699),C=o(1865),M=o(86628),S=o(98519),F=o(55332),b=o(79576),w=o(73420),O=o(68785),T=o(6854),N=o(85893);const W=function(e){let{environment:t,inferenceIds:o,aiInference:n}=e;window.__c={n:"AiAutofillProgressLabel"};const i=(0,M.VK)((()=>{const{state:e}=b.W;return"uninitialized"===e.type?null:{numBlocksToAutofill:e.numBlocksToAutofill,numBlocksAutofilled:e.numBlocksAutofilled,propertySchema:e.propertySchema,collectionId:e.collectionId,sessionId:e.sessionId,haveAllBlocksCompletedAutofill:e.haveAllBlocksCompletedAutofill}}),[]),a=(0,r.useCallback)((()=>{i&&(o.forEach((e=>{u.qG2(t,{ai_inference_type:n.type,type:"undo_from_snackbar",inference_id:e,collection_id:i.collectionId,session_id:i.sessionId})})),F.Yw(t,!0),v.rN(),b.W.setState({type:"filling",...i,didInterruptStreaming:!0}))}),[i,t,n,o]);if(!i)return null;const{numBlocksToAutofill:l,numBlocksAutofilled:c,propertySchema:{name:d}}=i;return c===l?(0,N.jsxs)(w.X2,{gap:4,alignItems:"center",children:[(0,S.k)({width:16}),(0,N.jsx)(s.FormattedMessage,{defaultMessage:'AI updated "{propertyName}" on {numPages, plural, one {1 page} other {# pages}}',id:"snackbar.aiAutofill.autofillInProgress",values:{propertyName:d,numPages:l}}),(0,N.jsx)(T.Pn,{onClick:a,children:(0,N.jsx)(s.FormattedMessage,{defaultMessage:"Undo",id:"snackbar.aiAutofill.undo"})}),(0,N.jsx)(T.Pn,{onClick:()=>{v.rN()},children:(0,N.jsx)(s.FormattedMessage,{defaultMessage:"Close",id:"snackbar.aiAutofill.close"})})]}):(0,N.jsxs)(w.X2,{gap:4,alignItems:"center",children:[(0,N.jsx)(O.Z,{}),0===c?(0,N.jsx)(s.FormattedMessage,{defaultMessage:'AI updating "{propertyName}" on {numPages, plural, one {1 page} other {# pages}}',id:"snackbar.aiAutofill.autofillStarting",values:{propertyName:d,numPages:l}}):(0,N.jsx)(s.FormattedMessage,{defaultMessage:'AI updated "{propertyName}" on {numFilledPages} of {numTotalPages} pages',id:"snackbar.aiAutofill.completedAutofill",values:{propertyName:d,numFilledPages:c,numTotalPages:l}}),(0,N.jsx)(T.Pn,{onClick:a,children:(0,N.jsx)(s.FormattedMessage,{defaultMessage:"Stop & undo",id:"snackbar.aiAutofill.undoAndStop"})})]})};var x=o(91396),L=o(33929),j=o(77907),B=o(80444),R=o(90106),U=o(1310),E=o(78291),q=o(35057),D=o(84254);const Z=(0,s.defineMessages)({fillAllPagesTooltip:{defaultMessage:"{hasNames, select, true {Autofill {propertyName} for all pages in {collectionName}} other {Autofill this property for all pages in the database}}",id:"aiAutofill.fillAllPages.buttonTooltip"},fillAllPagesAddOnMessage:{defaultMessage:"Only with Notion AI add-on",id:"aiAutofill.fillAllPages.onlyWithAiAddOnMessageInTooltip"}});function V(e){let{environment:t,propertyId:o,storesWithCompletions:r,blockIdToInferenceId:n,useTemporaryStore:i,markdownLinkifyIt:a,tinyMceMicrosoftWordPasteFilter:l}=e;P.createAndCommit({userAction:"BlockPropertyValue.handleActionButtonClick.aiAutofill",environment:t,canUndo:!Boolean(i),undoCheckpoint:!0,perform:e=>{for(const{store:t,temporaryStore:s,completion:c}of r){const r=i?s:t;k.sO({store:r.getPropertyStore(o),value:g.of({text:c.trim(),stripText:!1,markdownLinkifyIt:a,tinyMceMicrosoftWordPasteFilter:l}),transaction:e});const d=r.getFormat().ai_property_inference_map??{},p=n[t.id]??"";h.FH({stores:[r],update:{ai_property_inference_map:{...d,[o]:{inference_id:p,created_time:Date.now()}}},transaction:e})}}})}const K=(0,s.defineMessages)({FAILED_TO_AUTOFILL:{defaultMessage:"Something went wrong. Please try again later",id:"propertyCompletionActions.error.unableToAutofill"},INVALID_PROPERTY_FOR_AUTOFILL:{defaultMessage:"Invalid property configuration for AI autofill",id:"propertyCompletionActions.error.invalidPropertyForAutofill"},NO_BLOCKS_TO_AUTOFILL:{defaultMessage:"Nothing to update with AI",id:"propertyCompletionActions.error.noBlocksToAutofill"}}),z=(0,s.defineMessages)({featureUnavailable:{id:"completionActions.featureNotEnabledError",defaultMessage:"This feature is not currently enabled"}});function H(e){let{autofillPropertyResult:t}=e;const o=L.default.formatMessage(K[t]);v.rN(),I.deprecatedShowErrorMessage(o)}const Y={ai_limit_property_autofill:(0,N.jsx)(s.FormattedMessage,{defaultMessage:"This workspace has used all of its free AI responses. Contact your workspace owner to add Notion AI.",id:"aiAutofill.outOfAiUpsellDialogMessage"}),ai_autofill_on_page_edit:(0,N.jsx)(s.FormattedMessage,{defaultMessage:"Auto-update requires the Notion AI Add-on. Contact your workspace owner to add Notion AI.",id:"aiAutofill.autoUpdateOnPageEditUpsellDialogMessage"}),ai_autofill_fill_all_pages:(0,N.jsx)(s.FormattedMessage,{defaultMessage:"Updating all pages requires the Notion AI Add-on. Contact your workspace owner to add Notion AI.",id:"aiAutofill.fillAllPagesUpsellDialogMessage"}),ai_autofill_bulk_fill:(0,N.jsx)(s.FormattedMessage,{defaultMessage:"Filling more pages at once requires the Notion AI Add-on. Contact your workspace owner to add Notion AI.",id:"aiAutofill.bulkFillUpsellDialogMessage"})};function G(e){var t;let{environment:o,from:r}=e;null!==(t=B.default.state.currentSpaceStore)&&void 0!==t&&t.canAdmin()||I.deprecatedShowErrorMessage(Y[r]),C.y(o,{from:r,for:(0,q.zt)(),addOnFeature:"ai"})}function Q(e){let{errorCode:t,environment:o}=e;return 405===t?v.oV({label:L.default.formatMessage(z.featureUnavailable)}):(402===t&&(v.rN(),G({environment:o,from:"ai_limit_property_autofill"})),D.showCompletionErrorWithCode(t))}async function X(e){var t;let{environment:o,stores:r,property:l,propertySchema:s,userEventForAnalytics:c,sessionIdForAnalytics:p,collectionContextStore:g,from:_,isBulkAction:A,aiInferenceOverride:I}=e;const h=p||(0,d.ZP)(),k=l,P=r.map((e=>({spaceId:e.getSpaceId(),...e.pointer,propertyId:k,inferenceId:(0,d.ZP)()}))),C=r[0].getParentCollectionId()??(null===(t=r[0].getCollectionViewCollectionStore())||void 0===t?void 0:t.id),M=new n.Z({name:"propertyCompletionActions.autofillPropertyForBlocks"});if(b.W.setIsWriting({stores:r,propertySchema:s,sessionIdForAnalytics:p}),"uninitialized"!==b.W.state.type&&(0,i.qQ)(s)){v.oV({label:(0,N.jsx)(W,{environment:o,inferenceIds:P.map((e=>e.inferenceId)),aiInference:(0,i.q3)(s)}),durationMs:U.JY});try{var S;if(o.defaultRecordCache.inMemoryRecordCache.addCacheOverride(M),!(0,f.Of)(P))return H({autofillPropertyResult:"NO_BLOCKS_TO_AUTOFILL"});const e=I||(0,i.q3)(s);if(!e)return H({autofillPropertyResult:"INVALID_PROPERTY_FOR_AUTOFILL"});P.forEach((t=>{u.qG2(o,{type:c,inference_id:t.inferenceId,ai_inference_type:e.type,collection_id:C,session_id:h})})),null!==(S=B.default.state.currentSpaceStore)&&void 0!==S&&S.id&&y.publishAiSession(o,{inference_type:"autofill",id:h,spaceId:B.default.state.currentSpaceStore.id,metadata:{blockPropertyPointers:P,aiInference:e,collection_id:C}});const t=await y.getCompletionForProperty(o,{blockPropertyPointers:P,aiInference:e,aiSessionId:h,model:(0,x.PD)(o)});if("success"!==t.type)return H({autofillPropertyResult:"FAILED_TO_AUTOFILL"});g&&m.rv({block_id:r[0].pointer.id,property:k,property_type:s.type,from:_,environment:o,collectionContextStore:g,isFromBulkActionsToolbar:A});const n=Object.fromEntries(r.map((e=>[e.pointer.id,{store:e,temporaryStore:e.clone(M),completion:""}]))),l=Object.fromEntries(P.map((e=>[e.id,e.inferenceId]))),d=new Set,[p,v]=await Promise.all([j.deps.markdownLinkifyIt.loader(),j.deps.tinyMceMicrosoftWordPasteFilter.loader()]);if(a.H1.is(t.data)){for await(const e of t.data){if("error"===e.type)return b.W.setState({...b.W.state,didInterruptStreaming:!0}),Q({errorCode:e.errorCode,environment:o});if(b.W.state.didInterruptStreaming)return;const t=n[e.blockPropertyPointer.id],r=t.completion+e.completion;n[e.blockPropertyPointer.id]={...t,completion:r},d.add(e.blockPropertyPointer.id),V({environment:o,propertyId:k,storesWithCompletions:Object.values(n),blockIdToInferenceId:l,useTemporaryStore:!0,markdownLinkifyIt:p,tinyMceMicrosoftWordPasteFilter:v}),b.W.setState({...b.W.state,numBlocksAutofilled:d.size})}b.W.setState({...b.W.state,haveAllBlocksCompletedAutofill:!0})}o.defaultRecordCache.inMemoryRecordCache.removeCacheOverride(M),V({environment:o,propertyId:k,storesWithCompletions:Object.values(n),blockIdToInferenceId:l,useTemporaryStore:!1,markdownLinkifyIt:p,tinyMceMicrosoftWordPasteFilter:v})}finally{o.defaultRecordCache.inMemoryRecordCache.hasCacheOverride(M)&&o.defaultRecordCache.inMemoryRecordCache.removeCacheOverride(M)}}}function J(e){const{environment:t,inferenceId:o,feedbackType:r,userContent:n,shareWithNotion:i}=e;u.NF$(t,{type:"property_autofill",inference_id:o,feedback_type:r,timestamp:(new Date).toUTCString(),user_comment:n,share_with_notion:i})}async function $(e){var t,o;let{environment:r,collectionStore:n,propertySchema:a,property:s,sessionIdForAnalytics:f,includedCollectionSchemaUpdateOp:m}=e;if(!(0,i.qQ)(a))return;const y=(0,i.q3)(a);if(!n||!a||!y)return;const g=(null===(t=E.default.state.data)||void 0===t?void 0:t.addOns)??[];if(!(0,p.de)(g))return void G({environment:r,from:"ai_autofill_fill_all_pages"});if(!(await A.r({sourceAction:"fill_all_pages",propertyName:a.name,collectionName:(null===(o=n.getName())||void 0===o?void 0:o.toString())||""})))return;u.qG2(r,{type:"generate_from_fill_all_pages",inference_id:(0,d.ZP)(),ai_inference_type:y.type,collection_id:n.id,session_id:f??(0,d.ZP)()});const I=l.oA([m]);I.push(c.op.update({pointer:n.pointer,path:["format","update_ai_inferences_status"],args:{[s]:{type:"requested",created_time:Date.now()}}})),_.HW({environment:r,collectionStore:n,performTransaction:e=>{for(const t of I)P.applyOperation({store:(0,R.Kv)(n,t.pointer),operation:t,transaction:e})}})}function ee(e){const{environment:t,propertySchema:o,collectionStore:r,property:n,draftAiInference:a}=e;let l="";switch(o.type){case"text":l="ai_inference";break;case"select":case"multi_select":l="select_ai_inference";break;default:return}const s=[];if(s.push({pointer:r.pointer,command:"set",path:["schema",n,l],args:a}),a)u._eA(t,{type:"set_ai_inference",ai_inference_type:a.type,collection_id:r.id});else{const e=(0,i.q3)(o);u._eA(t,{type:"remove_ai_inference",ai_inference_type:null==e?void 0:e.type,collection_id:r.id})}_.HW({environment:t,collectionStore:r,performTransaction:e=>{for(const t of s)P.applyOperation({store:(0,R.Kv)(r,t.pointer),operation:t,transaction:e})}})}}}]);